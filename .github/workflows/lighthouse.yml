name: Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:
    # Run on all PRs during development

env:
  PRIMARY_NODE_VERSION: '22.x'

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.PRIMARY_NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.PRIMARY_NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.15.x

      - name: Start HTTP Server
        run: |
          npx http-server dist/moodyjw-portfolio/browser -p 8080 &
          echo $! > server.pid
          npx wait-on http://localhost:8080 -t 60000
          echo "‚úÖ Server started on port 8080"

      - name: Run Lighthouse CI
        run: |
          echo "Running Lighthouse CI collect..."
          lhci collect --config=lighthouserc.json
          
          echo "Running Lighthouse CI assert..."
          lhci assert --config=lighthouserc.json || echo "‚ö†Ô∏è Assertions had warnings (non-blocking)"
          
          echo "Checking manifest..."
          if [ -f ".lighthouseci/manifest.json" ]; then
            echo "‚úÖ Lighthouse manifest created"
            cat .lighthouseci/manifest.json
          else
            echo "‚ùå Manifest not found"
            ls -la .lighthouseci/ || echo "No .lighthouseci directory"
          fi
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stop HTTP Server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci
          retention-days: 30

      - name: Comment PR with Lighthouse scores
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              // Find the latest manifest file
              const lhciDir = '.lighthouseci';
              const manifestPath = path.join(lhciDir, 'manifest.json');
              
              if (!fs.existsSync(manifestPath)) {
                console.log('No Lighthouse manifest found');
                return;
              }
              
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              
              if (!manifest || manifest.length === 0) {
                console.log('Manifest is empty');
                return;
              }
              
              // Get the first result (we only run one URL)
              const result = manifest[0];
              const reportPath = path.join(lhciDir, result.jsonPath);
              
              if (!fs.existsSync(reportPath)) {
                console.log('Report file not found:', reportPath);
                return;
              }
              
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              // Extract scores
              const categories = report.categories;
              const performance = Math.round(categories.performance.score * 100);
              const accessibility = Math.round(categories.accessibility.score * 100);
              const bestPractices = Math.round(categories['best-practices'].score * 100);
              const seo = Math.round(categories.seo.score * 100);
              
              // Extract key metrics
              const audits = report.audits;
              const fcp = audits['first-contentful-paint'].displayValue;
              const lcp = audits['largest-contentful-paint'].displayValue;
              const tbt = audits['total-blocking-time'].displayValue;
              const cls = audits['cumulative-layout-shift'].displayValue;
              const si = audits['speed-index'].displayValue;
              
              // Determine emoji based on score
              const getEmoji = (score) => {
                if (score >= 90) return 'üü¢';
                if (score >= 50) return 'üü†';
                return 'üî¥';
              };
              
              // Create comment body
              const commentBody = [
                '## üî¶ Lighthouse Audit Results',
                '',
                '| Category | Score |',
                '|----------|-------|',
                `| ${getEmoji(performance)} Performance | **${performance}** |`,
                `| ${getEmoji(accessibility)} Accessibility | **${accessibility}** |`,
                `| ${getEmoji(bestPractices)} Best Practices | **${bestPractices}** |`,
                `| ${getEmoji(seo)} SEO | **${seo}** |`,
                '',
                '### Core Web Vitals',
                '',
                '| Metric | Value |',
                '|--------|-------|',
                `| First Contentful Paint (FCP) | ${fcp} |`,
                `| Largest Contentful Paint (LCP) | ${lcp} |`,
                `| Total Blocking Time (TBT) | ${tbt} |`,
                `| Cumulative Layout Shift (CLS) | ${cls} |`,
                `| Speed Index (SI) | ${si} |`,
                '',
                '### Performance Budgets',
                '',
                `- ${performance >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} Performance: Target ‚â•80, Current: ${performance}`,
                `- ${accessibility >= 95 ? '‚úÖ' : '‚ùå'} Accessibility: Target ‚â•95, Current: ${accessibility}`,
                `- ${bestPractices >= 90 ? '‚úÖ' : '‚ö†Ô∏è'} Best Practices: Target ‚â•90, Current: ${bestPractices}`,
                `- ${seo >= 85 ? '‚úÖ' : '‚ö†Ô∏è'} SEO: Target ‚â•85, Current: ${seo}`,
                '',
                performance < 80 ? '‚ö†Ô∏è **Performance score is below target (80)**' : '',
                accessibility < 95 ? '‚ùå **Accessibility score is below target (95)** - Build will fail!' : '',
                bestPractices < 90 ? '‚ö†Ô∏è **Best Practices score is below target (90)**' : '',
                seo < 85 ? '‚ö†Ô∏è **SEO score is below target (85)**' : '',
                '',
                `*Lighthouse CI run for commit ${context.sha.substring(0, 7)}*`
              ].filter(line => line !== '').join('\n');

              // Post comment to PR (only if this is a pull request event)
              if (context.eventName === 'pull_request' && context.payload.pull_request) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: commentBody
                });
                console.log('Posted Lighthouse results to PR #' + context.payload.pull_request.number);
              } else {
                console.log('Not a pull request event, skipping comment');
                console.log('Lighthouse Results:\n' + commentBody);
              }
              
              // Fail the job only if accessibility is below threshold (hard requirement)
              if (accessibility < 95) {
                core.setFailed('Accessibility score below required threshold (95)');
              }
              
            } catch (error) {
              console.error('Error processing Lighthouse results:', error);
              core.setFailed(error.message);
            }

  lighthouse-status:
    name: Lighthouse Status Check
    runs-on: ubuntu-latest
    needs: [lighthouse]
    if: always()

    steps:
      - name: Check Lighthouse job status
        run: |
          if [[ "${{ needs.lighthouse.result }}" == "success" ]]; then
            echo "‚úÖ Lighthouse audit passed"
            exit 0
          else
            echo "‚ùå Lighthouse audit failed or was cancelled"
            exit 1
          fi
